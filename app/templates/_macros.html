{# Generic reusable helpers to reduce duplication #}
{% macro image_block(image_url) %}
    {% if image_url is string and image_url.startswith('<svg') %}
        <div class="card-img-top" alt="NFT Image">
            {{ image_url | safe }}
        </div>
    {% else %}
        <img src="{{ image_url }}" class="card-img-top" alt="NFT Image">
    {% endif %}
{% endmacro %}

{# Grid row macro with caller for flexible item rendering #}
{% macro grid_row(items) %}
<div class="row">
    {% for item in items %}
    <div class="col">
        {% if caller %}
            {{ caller(item) }}
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endmacro %}

{# Backward-compatible wrappers using grid_row #}
{% macro nft_row(nfts) %}
    {% call(item) grid_row(nfts) %}
        {{ nft_card(item) }}
    {% endcall %}
{% endmacro %}

{% macro proposals_row(proposals, current_wallet_address, nft_owner_address, contract_address, token_id) %}
    {% call(p) grid_row(proposals) %}
        {{ proposal_card(p, current_wallet_address, nft_owner_address, contract_address, token_id) }}
    {% endcall %}
{% endmacro %}

{% macro marketplace_nft_row(nfts, current_wallet_address) %}
    {% call(item) grid_row(nfts) %}
        {{ marketplace_nft_card(item, current_wallet_address) }}
    {% endcall %}
{% endmacro %}

{% macro nft_card(nft) %}
<div class="card d-flex flex-column" style="width: 18rem;">
    {{ image_block(nft.image_url) }}
    <div class="card-body flex-grow-1 d-flex flex-column">
        <h5 class="card-title">{{ nft.name }}</h5>
        <p class="card-text mb-3">
            <strong>Symbol:</strong> {{ nft.symbol }}<br>
            <strong id="contract_address">Contract:</strong> {{ nft.contract_address }}<br>
            <strong id="token_id">Token ID:</strong> {{ nft.token_id }}
        </p>
        {% if nft.listed %}
            <small class="text-success mb-2">This NFT is listed on the marketplace.</small>
            <button class="btn btn-warning unlistBtn mt-auto" data-contract="{{ nft.contract_address }}" data-tokenid="{{ nft.token_id }}">
                Unlist NFT
            </button>
            <a href="/nfts/view-proposals/{{ nft.contract_address | urlencode }}/{{ nft.token_id | urlencode }}" class="btn btn-secondary viewProposalsBtn">View proposals</a>
        {% else %}
            <a href="/nfts/list?contract_address={{ nft.contract_address | urlencode }}&token_id={{ nft.token_id | urlencode }}"
               class="btn btn-primary mt-auto">
                List NFT
            </a>
        {% endif %}
    </div>
</div>
{% endmacro %}


{% macro marketplace_nft_card(nft, current_wallet_address=None) %}
<div class="card" style="width: 18rem;">
    {{ image_block(nft.image_url) }}
    <div class="card-body">
        <p class="card-text">
            <strong>Symbol:</strong> {{ nft.symbol }}<br>
            <strong id="contract_address">Contract:</strong> {{ nft.contract_address }}<br>
            <strong id="contract_owner">Owner:</strong> {{ nft.owner }}<br>
            <strong id="token_id">Token ID:</strong> {{ nft.token_id }}<br>
            <strong>Price: </strong> {{ nft.price }} $MON
        </p>
        <a href="/nfts/view-proposals/{{ nft.contract_address | urlencode }}/{{ nft.token_id | urlencode }}" class="btn btn-secondary viewProposalsBtn">View proposals</a>
        {% if current_wallet_address and nft.owner|lower == current_wallet_address|lower %}
            <button class="btn btn-warning unlistBtn" data-contract="{{ nft.contract_address }}" data-tokenid="{{ nft.token_id }}">Unlist</button>
        {% endif %}
        {% if current_wallet_address and current_wallet_address|lower != nft.owner|lower %}
            <a href="/nfts/make_offer/{{ nft.contract_address | urlencode }}/{{ nft.token_id | urlencode }}"
            class="btn btn-primary makeOfferBtn"
            data-contract="{{ nft.contract_address }}"
            data-tokenid="{{ nft.token_id }}">Make an offer</a>
        {% endif %}

    </div>
</div>
{% endmacro %}


{% macro proposal_card(proposal, current_wallet_address, nft_owner_address, contract_address, token_id) %}
<div class="card mb-3" style="width: 18rem;">
    <div class="card-body">
        <p class="card-text">
            <strong>Proposer:</strong> {{ proposal.proposer }}<br>
            <strong>Price:</strong> {{ proposal.price }} $MON
        </p>
        {% if current_wallet_address and proposal.proposer == current_wallet_address %}
        <button class="btn btn-danger cancelProposal" 
                data-proposer="{{ proposal.proposer }}" 
                data-price="{{ proposal.price }}"
                data-contract="{{ contract_address }}"
                data-tokenid="{{ token_id }}">
            Cancel Proposal
        </button>
        {% endif %}
        {% if current_wallet_address and nft_owner_address and current_wallet_address == nft_owner_address %}
        <button class="btn btn-success acceptProposal" 
                data-proposer="{{ proposal.proposer }}" 
                data-price="{{ proposal.price }}"
                data-contract="{{ contract_address }}"
                data-tokenid="{{ token_id }}"
                data-buyer="{{proposal.proposer}}">
            Accept Proposal
        </button>
        {% endif %}
    </div>
</div>

{% endmacro %}

